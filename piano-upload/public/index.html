<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Télécharger un fichier WAV</title>
    <style>
        #file-list {
            margin-top: 20px;
        }
    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>

<body class="container mt-5">
    <h1 class="text-center">Télécharger un fichier WAV</h1>
    <form action="/upload" method="post" enctype="multipart/form-data" class="mb-4" 
		onsubmit="showSuccessMessage(event)">
    
<div id="help" class="mt-4">
    <h2>Instructions</h2>
        <p>1. Choisissez votre fichier son dans la liste déroulante.</p>
        <p>2. Sélectionnez un fichier .wav à télécharger.</p>
        <p>3. Cliquez sur le bouton "Télécharger".</p>
        <p>4. Les fichiers téléchargés apparaîtront ci-dessous. Vous pourrez les lire.</p>
</div>
<div class="form-group">
            <label for="note">Choisissez votre fichier son :</label>
            <select name="note" id="note" class="form-control" required onchange="loadFiles()">
                <option value="Key1">Key1</option>
                <option value="Key2">Key2</option>
                <option value="Key3">Key3</option>
                <option value="Key4">Key4</option>
                <option value="Key5">Key5</option>
                <option value="Key6">Key6</option>
                <option value="Key7">Key7</option>
                <option value="Key8">Key8</option>
                <option value="Key9">Key9</option>
                <option value="Key10">Key10</option>
                <option value="Key11">Key11</option>
                <option value="Key12">Key12</option>
            </select>
        </div>
        <div class="form-group">
            <input type="file" name="file" accept=".wav" required class="form-control-file">
        </div>
        <button type="submit" class="btn btn-primary">Télécharger</button>
    </form>

    <div id="file-list">
      <h2>Fichiers disponibles :</h2>
      <ul id="files"></ul>
    </div>

    <script>
	function loadFiles() {
    const note = document.getElementById('note').value;
    const fileList = document.getElementById('files');
    fileList.innerHTML = '<li>Chargement...</li>'; // Indicateur de chargement

    fetch(`/files/${note}`)
        .then(response => response.json())
        .then(files => {
            fileList.innerHTML = ''; // Vider le message de chargement
            if (files.length === 0) {
                fileList.innerHTML = '<li>Aucun fichier disponible.</li>'; // Alerte si aucun fichier
            } else {
                files.forEach(file => {
                    const listItem = document.createElement('li');
                    listItem.textContent = file; 

                    // Créez un bouton pour supprimer le fichier
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Supprimer';
                    deleteButton.onclick = () => deleteFile(note, file);
                    deleteButton.className = 'btn btn-danger btn-sm ml-2'; // Ajoutez une classe Bootstrap pour le style

                    listItem.appendChild(deleteButton);
                    fileList.appendChild(listItem);
                });
            }
        })
        .catch(error => {
            fileList.innerHTML = '<li>Erreur lors du chargement des fichiers.</li>'; // Message d'erreur
            console.error('Erreur lors du chargement des fichiers :', error);
        });
}

function deleteFile(note, filename) {
    fetch(`/delete/${note}/${filename}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Erreur de suppression');
        }
        return response.json();
    })
    .then(data => {
        alert(data.message); // Affichez le message de réussite
        loadFiles(); // Rechargez la liste des fichiers
    })
    .catch(error => {
        alert('Erreur lors de la suppression : ' + error); // Affichez une erreur si quelque chose ne va pas
        console.error('Erreur de suppression :', error);
    });
}


    // La fonction JavaScript pour afficher le message
	function showSuccessMessage(event) {
   	event.preventDefault(); // Empêche le rafraîchissement
    	const formData = new FormData(event.target);
    	fetch(event.target.action, {
        method: 'POST',
        body: formData
    	})
    	.then(response => response.text())
    	.then(message => {
        	alert(message); // Alerte de succès
        	loadFiles(); // Recharge les fichiers
    	})
    .catch(error => alert("Erreur : " + error));
	}
	
	   function deleteFile(note, filename) {
        fetch(`/delete/${note}/${filename}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
        alert(data.message);
        loadFiles(); // Recharge la liste
       })
        .catch(error => console.error('Erreur de suppression :', error));
        }
    </script>
</body>
</html>

